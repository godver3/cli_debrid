{% extends "base.html" %}

{% block title %}Scraper Tester{% endblock %}

{% block head %}
    {{ super() }}
    <meta http-equiv="refresh" content="300">
    <script>
        // Dynamically load the correct CSS based on theme cookie
        (function() {
            const theme = document.cookie.split('; ').find(row => row.startsWith('selectedTheme='))?.split('=')[1] || 'classic';
            const cssFile = theme === 'tangerine' ? 'css/tangerine/tangerine_scraper_tester.css' : 'css/scraper_tester.css';
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            // Add cache-busting parameter based on theme to force reload when theme changes
            link.href = '{{ url_for("static", filename="") }}' + cssFile + '?v=' + theme + '_' + Date.now();
            document.head.appendChild(link);
        })();
    </script>
    {% endblock %}

{% block content %}
<div class="mobile-warning">
    The Scraper Tester cannot be used on mobile devices. Please access it from a desktop computer.
</div>
<div class="scraper-tester-container">
    <h1>Scraper Tester</h1>
    <div id="search-section">
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Enter search term..." class="settings-input">
            <button id="search-button" class="settings-submit-button">Search</button>
        </div>
        <div id="search-results" class="search-results"></div>
    </div>
    <div id="scrape-section" style="display: none;">
        <div id="scrape-details" class="scraper-tester-section">
            <div class="scraper-tester-section-header">
                <h4>Scrape Details</h4>
            </div>
            <div class="scraper-tester-section-content active">
                <input type="hidden" id="imdbId">
                <div id="selected-item"></div>
                <div class="form-group">
                    <label for="version-select">Version:</label>
                    <select id="version-select" class="settings-input">
                        {% for version in versions %}
                            <option value="{{ version }}">{{ version }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="tv-controls" style="display: none;">
                    <div class="form-group">
                        <label for="season-select">Season:</label>
                        <select id="season-select" class="settings-input"></select>
                    </div>
                    <div class="form-group">
                        <label for="episode-select">Episode:</label>
                        <select id="episode-select" class="settings-input"></select>
                    </div>
                    <div class="form-group">
                        <label for="multi-checkbox">Multi:</label>
                        <input type="checkbox" id="multi-checkbox" class="settings-input">
                    </div>
                </div>
                <div class="version-settings-container">
                    <div id="originalSettings" class="settings-column">
                        <h3>Original Settings</h3>
                        <!-- Original settings will be populated here -->
                    </div>
                    <div id="modifiedSettings" class="settings-column">
                        <h3>Modified Settings</h3>
                        <!-- Editable settings will be populated here -->
                    </div>
                </div>
                <button id="run-scrape-button" class="settings-submit-button">Run Scrape</button>
            </div>
        </div>
        <div id="scrape-results" class="scrape-results">
            <div class="results-columns">
                <div id="original-results" class="results-column">
                    <h3>Original Results</h3>
                    <!-- Filtered out original results will be merged here -->
                </div>
                <div id="adjusted-results" class="results-column">
                    <h3>Adjusted Results</h3>
                    <!-- Filtered out adjusted results will be merged here -->
                </div>
            </div>
        </div>
        <div id="score-breakdown" class="scraper-tester-section">
            <div class="score-breakdown-header">
                <h4>Score Breakdown</h4>
            </div>
            <div class="scraper-tester-section-content"></div>
        </div>
        <button id="save-settings-button" class="settings-submit-button" style="display: none;">Save Modified Settings</button>
        <button id="new-search-button" class="settings-submit-button">New Search</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        (function() {
            const originalFetch = window.fetch;
            window.fetch = async function(input, init) {
                try {
                    const url = typeof input === 'string' ? input : (input && input.url) || '';
                    const method = (init && init.method) ? init.method.toUpperCase() : 'GET';
                    if (url.endsWith('/scraper/scraper_tester') && method === 'POST') {
                        // Reroute to content search to avoid backend expecting mediaType
                        const resp = await originalFetch('/content/search', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: init && init.body ? init.body : JSON.stringify({})
                        });
                        const data = await resp.json();
                        const transformed = Array.isArray(data) ? data.map(r => {
                            if (r && !r.mediaType) {
                                const mt = r.media_type || r.mediaType;
                                r.mediaType = mt === 'show' ? 'tv' : (mt || 'movie');
                            }
                            return r;
                        }) : data;
                        return new Response(JSON.stringify(transformed), { status: 200, headers: { 'Content-Type': 'application/json' }});
                    }
                } catch (e) {
                    console.error('Scraper Tester fetch shim error:', e);
                }
                return originalFetch.apply(this, arguments);
            };
        })();
    </script>
    <script src="{{ url_for('static', filename='js/loading.js') }}"></script>
    <script src="{{ url_for('static', filename='js/scraper_tester.js') }}"></script>

{% endblock %}
