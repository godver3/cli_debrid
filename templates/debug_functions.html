{% extends "base.html" %}

{% block title %}Debug Functions{% endblock %}

{% block content %}
<style>
    .debug-container {
        width: 100%;
        max-width: none;
        padding: 20px;
        background-color: #444;
        border-radius: 5px;
    }

    h2, h3 {
        color: #f4f4f4;
        margin-bottom: 20px;
    }

    form {
        display: flex;
        flex-direction: column;
        max-width: 600px;
        margin: 0;
    }

    label {
        color: #f4f4f4;
        margin-bottom: 5px;
    }

    input[type="text"] {
        padding: 8px;
        margin-bottom: 15px;
        background-color: #555;
        border: 1px solid #666;
        color: #f4f4f4;
        border-radius: 3px;
    }

    button {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 10px 15px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s;
    }

    button:hover {
        background-color: #d32f2f;
    }

    .popup {
        display: none;
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
    }

    /* New styles for left alignment */
    .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .form-group label {
        width: 320px;  // Increased from 80px to 160px
        margin-bottom: 0;
        margin-right: 10px;
    }

    .form-group input[type="text"] {
        flex-grow: 1;
        margin-bottom: 0;
    }

    .form-actions {
        margin-left: 0px;  // Adjusted to align with the wider label
    }

    /* Add this new style for spacing between sections */
    .debug-section {
        margin-bottom: 30px;
    }

    #confirmation-popup {
        text-align: center;
    }

    #confirmation-popup button {
        margin: 10px;
        padding: 5px 10px;
        cursor: pointer;
    }

    #confirm-yes {
        background-color: #4CAF50;
        color: white;
        border: none;
    }

    #confirm-no {
        background-color: #f44336;
        color: white;
        border: none;
    }

    .confirmation-popup {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .confirmation-popup-content {
        background-color: #333;
        color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 5px;
    }

    .confirmation-popup-content h3 {
        margin-top: 0;
        color: #fff;
    }

    .confirmation-buttons {
        text-align: right;
        margin-top: 20px;
    }

    .confirmation-buttons button {
        padding: 8px 15px;
        margin-left: 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 14px;
    }

    #confirmYes {
        background-color: #4CAF50;
        color: white;
    }

    #confirmNo {
        background-color: #f44336;
        color: white;
    }

    .notification-popup {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }

    .notification-popup-content {
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-size: 16px;
        max-width: 300px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

</style>

<div class="debug-container">
    <h2>Debug Functions</h2>

    <div class="debug-section">
        <h3>Bulk Delete from Database</h3>
        <form action="{{ url_for('bulk_delete_by_imdb') }}" method="POST" id="bulk-delete-form">
            <div class="form-group">
                <label for="imdb_id">IMDB ID:</label>
                <input type="text" id="imdb_id" name="imdb_id" required>
            </div>
            <div class="form-actions">
                <button type="submit">Delete</button>
            </div>
        </form>
    </div>

    <div class="debug-section">
        <h3>Download Debug Logs</h3>
        <form action="{{ url_for('api_logs') }}" method="GET" id="download-logs-form">
            <div class="form-group">
                <label for="log_lines">Number of log lines:</label>
                <input type="number" id="log_lines" name="lines" value="500" min="1" max="10000" required>
            </div>
            <input type="hidden" name="download" value="true">
            <div class="form-actions">
                <button type="submit">Download Logs</button>
            </div>
        </form>
    </div>

    <div class="debug-section">
        <h3>Delete Database</h3>
        <form action="{{ url_for('delete_database') }}" method="POST" id="delete-database-form">
            <div class="form-group">
                <label for="confirm_delete">Type 'DELETE' to confirm:</label>
                <input type="text" id="confirm_delete" name="confirm_delete" required>
            </div>
            <div class="form-actions">
                <button type="submit">Delete Database</button>
            </div>
        </form>
    </div>
</div>

<div id="success-popup" class="popup"></div>
<div id="confirmation-popup" class="popup">
    <p id="confirmation-message"></p>
    <button id="confirm-yes">Yes</button>
    <button id="confirm-no">No</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('form');
        
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const url = form.action;
                const method = form.method;

                let confirmMessage = 'Are you sure you want to perform this action?';
                if (form.id === 'delete-database-form') {
                    const confirmDelete = document.getElementById('confirm_delete').value;
                    if (confirmDelete !== 'DELETE') {
                        showNotification('Please type DELETE to confirm database deletion', 'error');
                        return;
                    }
                    confirmMessage = 'Are you sure you want to delete the entire database? This action cannot be undone.';
                }

                showConfirmationPopup(confirmMessage, () => {
                    submitForm(url, method, new FormData(form));
                });
            });
        });

        function submitForm(url, method, formData) {
            fetch(url, {
                method: method,
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message || 'Action completed successfully', 'success');
                    if (method === 'POST' && url.includes('delete_database')) {
                        // Refresh the page after a short delay if the database was deleted
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    } else {
                        // Reset the form for other actions
                        const form = document.querySelector(`form[action="${url}"]`);
                        if (form) {
                            form.reset();
                        }
                    }
                } else {
                    throw new Error(data.error || 'An error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification(error.message || 'An error occurred', 'error');
            });
        }

        function showConfirmationPopup(message, onConfirm) {
            const popup = document.createElement('div');
            popup.className = 'confirmation-popup';
            popup.style.display = 'block';
            popup.innerHTML = `
                <div class="confirmation-popup-content">
                    <h3>Confirmation</h3>
                    <p>${message}</p>
                    <div class="confirmation-buttons">
                        <button id="confirmYes">Confirm</button>
                        <button id="confirmNo">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);

            document.getElementById('confirmYes').addEventListener('click', () => {
                onConfirm();
                popup.remove();
            });

            document.getElementById('confirmNo').addEventListener('click', () => {
                popup.remove();
            });
        }

        function showNotification(message, type) {
            // Remove any existing notifications
            const existingNotifications = document.querySelectorAll('.notification-popup');
            existingNotifications.forEach(notification => notification.remove());

            const popup = document.createElement('div');
            popup.className = 'notification-popup';
            popup.innerHTML = `
                <div class="notification-popup-content ${type}">
                    <h3>${type === 'success' ? 'Success' : 'Error'}</h3>
                    <p>${message}</p>
                    <button onclick="this.closest('.notification-popup').remove()">Close</button>
                </div>
            `;
            document.body.appendChild(popup);

            // Automatically remove the popup after 15 seconds
            setTimeout(() => {
                popup.remove();
            }, 15000);
        }

        function checkProgramStatus() {
            fetch('/api/program_status')
                .then(response => response.json())
                .then(data => {
                    const isRunning = data.running;
                    const buttons = document.querySelectorAll('button[type="submit"]');
                    buttons.forEach(button => {
                        button.disabled = isRunning;
                        button.style.opacity = isRunning ? '0.5' : '1';
                        button.style.cursor = isRunning ? 'not-allowed' : 'pointer';
                    });

                    const runningMessage = document.getElementById('programRunningMessage');
                    if (isRunning) {
                        if (!runningMessage) {
                            const message = document.createElement('div');
                            message.id = 'programRunningMessage';
                            message.textContent = 'Program is running. Debug functions are disabled.';
                            message.style.color = 'red';
                            message.style.marginBottom = '10px';
                            document.querySelector('.debug-container').prepend(message);
                        }
                    } else if (runningMessage) {
                        runningMessage.remove();
                    }
                })
                .catch(error => console.error('Error checking program status:', error));
        }

        checkProgramStatus();
        setInterval(checkProgramStatus, 5000);
    });
</script>
{% endblock %}