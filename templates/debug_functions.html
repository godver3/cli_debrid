{% extends "base.html" %}

{% block title %}Debug Functions{% endblock %}

{% block content %}
<style>
    .debug-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 30px;
        background-color: #2c2c2c;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h2, h3 {
        color: #f4f4f4;
        margin-bottom: 16px;
        border-bottom: 2px solid #444;
        padding-bottom: 10px;
    }

    form {
        display: flex;
        flex-direction: column;
        max-width: 100%;
        margin: 0;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
    }

    label {
        color: #f4f4f4;
        margin-bottom: 8px;
        font-weight: bold;
    }

    input[type="text"],
    input[type="number"], 
    select#collection_type, 
    select#wanted_source {
        padding: 10px;
        background-color: #3a3a3a;
        border: 1px solid #555;
        color: #f4f4f4;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        outline: none;
    }

    button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 12px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s;
    }

    button:hover {
        background-color: #0056b3;
    }

    .debug-section {
        margin-bottom: 40px;
        padding: 20px;
        background-color: #333;
        border-radius: 6px;
    }

    .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .loading-content {
        background-color: #333;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="debug-container">
    <h2>Debug Functions</h2>

    <h3>Bulk Delete from Database</h3>
    <form action="{{ url_for('bulk_delete_by_imdb') }}" method="POST" id="bulk-delete-form">
        <div class="form-group">
            <label for="imdb_id">IMDB ID:</label>
            <input type="text" id="imdb_id" name="imdb_id" required>
        </div>
        <button type="submit">Delete</button>
    </form>
    <h3>Download Logs</h3>
    <form id="download-logs-form">
        <div class="form-group">
            <label for="log_lines">Number of log lines:</label>
            <input type="number" id="log_lines" name="lines" value="250" min="1" max="1000">
        </div>
        <button type="submit">Download Logs</button>
    </form>
    <h3>Delete Database</h3>
    <form action="{{ url_for('delete_database') }}" method="POST" id="delete-database-form">
        <div class="form-group">
            <label for="confirm_delete">Type 'DELETE' to confirm:</label>
            <input type="text" id="confirm_delete" name="confirm_delete" required>
        </div>
        <button type="submit">Delete Database</button>
    </form>
    <h3>Get Collected from Plex</h3>
    <form action="{{ url_for('get_collected_from_plex') }}" method="POST" id="get-collected-form">
        <div class="form-group">
            <label for="collection_type">Collection Type:</label>
            <select id="collection_type" name="collection_type" required>
                <option value="all">All</option>
                <option value="recent">Recent</option>
            </select>
        </div>
        <button type="submit">Get Collected</button>
    </form>
    <h3>Get Wanted Content</h3>
    <form action="{{ url_for('get_wanted_content') }}" method="POST" id="get-wanted-form">
        <div class="form-group">
            <label for="wanted_source">Source:</label>
            <select id="wanted_source" name="source" required>
                <option value="all">All Enabled Sources</option>
                {% for source in content_sources %}
                    {% if content_sources[source].enabled %}
                        <option value="{{ source }}">{{ source }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <button type="submit">Get Wanted</button>
    </form>
</div>

<div id="loading" class="loading">
    <div class="loading-content">
        <div class="spinner"></div>
        <p>Processing command, please wait...</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('form');
        const loading = document.getElementById('loading');
        
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const url = form.action;
                const method = form.method;

                if (form.id === 'download-logs-form') {
                    downloadLogs();
                    return;
                }

                let confirmMessage = 'Are you sure you want to perform this action?';
                if (form.id === 'delete-database-form') {
                    const confirmDelete = document.getElementById('confirm_delete').value;
                    if (confirmDelete !== 'DELETE') {
                        showPopup({
                            type: POPUP_TYPES.ERROR,
                            message: 'Please type DELETE to confirm database deletion',
                            title: 'Error'
                        });
                        return;
                    }
                    confirmMessage = 'Are you sure you want to delete the entire database? This action cannot be undone.';
                } else if (form.id === 'get-collected-form') {
                    confirmMessage = 'Are you sure you want to get collected items from Plex?';
                } else if (form.id === 'get-wanted-form') {
                    confirmMessage = 'Are you sure you want to get wanted items from the selected source?';
                }

                showPopup({
                    type: POPUP_TYPES.CONFIRM,
                    message: confirmMessage,
                    title: 'Confirmation',
                    onConfirm: () => {
                        loading.style.display = 'flex';
                        submitForm(url, method, new FormData(form));
                    }
                });
            });
        });

        function submitForm(url, method, formData) {
            fetch(url, {
                method: method,
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                if (data.success) {
                    showPopup({
                        type: POPUP_TYPES.SUCCESS,
                        message: data.message || 'Action completed successfully',
                        title: 'Success'
                    });
                    if (method === 'POST' && url.includes('delete_database')) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    } else {
                        const form = document.querySelector(`form[action="${url}"]`);
                        if (form) {
                            form.reset();
                        }
                    }
                } else {
                    throw new Error(data.error || 'An error occurred');
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                console.error('Error:', error);
                showPopup({
                    type: POPUP_TYPES.ERROR,
                    message: error.message || 'An error occurred',
                    title: 'Error'
                });
            });
        }

        function downloadLogs() {
            const lines = document.getElementById('log_lines').value;
            const url = `/api/logs?lines=${lines}&download=true`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'debug.log';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showPopup({
                        type: POPUP_TYPES.ERROR,
                        message: 'Failed to download logs',
                        title: 'Error'
                    });
                });
        }


        function checkProgramStatus() {
            fetch('/api/program_status')
                .then(response => response.json())
                .then(data => {
                    const isRunning = data.running;
                    const buttons = document.querySelectorAll('button[type="submit"]');
                    buttons.forEach(button => {
                        button.disabled = isRunning;
                        button.style.opacity = isRunning ? '0.5' : '1';
                        button.style.cursor = isRunning ? 'not-allowed' : 'pointer';
                    });

                    const runningMessage = document.getElementById('programRunningMessage');
                    if (isRunning) {
                        if (!runningMessage) {
                            const message = document.createElement('div');
                            message.id = 'programRunningMessage';
                            message.textContent = 'Program is running. Debug functions are disabled.';
                            message.style.color = 'red';
                            message.style.marginBottom = '10px';
                            document.querySelector('.debug-container').prepend(message);
                        }
                    } else if (runningMessage) {
                        runningMessage.remove();
                    }
                })
                .catch(error => console.error('Error checking program status:', error));
        }

        checkProgramStatus();
        setInterval(checkProgramStatus, 5000);
    });
</script>
{% endblock %}