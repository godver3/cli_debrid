<h3>Scrapers Settings</h3>
<div class="settings-expand-collapse-buttons">
    <button type="button" class="settings-expand-all">Expand All</button>
    <button type="button" class="settings-collapse-all">Collapse All</button>
</div>

<button id="add-scraper-btn" class="add-scraper-link">Add New Scraper</button>

<script>
    function initializeScrapersFunctionality() {
        initializeAddScraperButton();
        initializeDeleteButtons();
        initializeScraperEnabledListeners();
        updateAllScraperHeaderColors();
    }

    function updateAllScraperHeaderColors() {
        document.querySelectorAll('.settings-section').forEach(section => {
            const checkbox = section.querySelector('input[type="checkbox"][id$="-enabled"]');
            if (checkbox) {
                updateScraperHeaderColor(section, checkbox.checked);
            }
        });
    }

    function updateScraperHeaderColor(section, isEnabled) {
        const header = section.querySelector('.settings-section-header');
        if (header) {
            if (isEnabled) {
                header.classList.remove('scraper-disabled');
            } else {
                header.classList.add('scraper-disabled');
            }
        }
    }

    function initializeScraperEnabledListeners() {
        document.querySelectorAll('input[type="checkbox"][id$="-enabled"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const section = this.closest('.settings-section');
                updateScraperHeaderColor(section, this.checked);
            });
        });
    }

    function initializeAddScraperButton() {
        const addButton = document.querySelector('#add-scraper-btn');
        if (addButton) {
            addButton.addEventListener('click', function(event) {
                event.preventDefault();
                showAddScraperPopup();
            });
        } else {
            console.error('Add scraper button not found');
        }
    }

    function showAddScraperPopup() {
        window.showPopup({
            type: POPUP_TYPES.PROMPT,
            title: 'Add New Scraper',
            message: 'Select the type of scraper you want to add:',
            dropdownOptions: [
                { value: 'Zilean', text: 'Zilean' },
                { value: 'MediaFusion', text: 'MediaFusion' },
                { value: 'AIOStreams', text: 'AIOStreams' },
                { value: 'Jackett', text: 'Jackett' },
                { value: 'Torrentio', text: 'Torrentio' },
                { value: 'Nyaa', text: 'Nyaa' },
                { value: 'Prowlarr', text: 'Prowlarr' },
                { value: 'OldNyaa', text: 'Old Nyaa (Do Not Use)' }
            ],
            confirmText: 'Add',
            cancelText: 'Cancel',
            onConfirm: (selectedType) => {
                if (selectedType) {
                    addScraper(selectedType);
                } else {
                    console.error('No scraper type selected');
                }
            }
        });
    }

    function addScraper(scraperType) {
        console.log('Adding scraper of type:', scraperType);
        window.showPopup({
            type: POPUP_TYPES.CONFIRM,
            title: 'Add Scraper',
            message: `Are you sure you want to add a scraper of type: ${scraperType}?`,
            confirmText: 'Add',
            cancelText: 'Cancel',
            onConfirm: () => {
                fetch('/settings/scrapers/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ type: scraperType })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (typeof window.reloadTabContent === 'function') {
                            window.reloadTabContent('scrapers', () => {
                                window.initializeExpandCollapse(); // Reinitialize expand/collapse
                                initializeScrapersFunctionality(); // Reinitialize scraper functionality
                                window.showPopup({
                                    type: POPUP_TYPES.SUCCESS,
                                    message: 'Scraper added and tab content reloaded successfully',
                                });
                            });
                        } else {
                            console.error('reloadTabContent is not a function');
                            window.showPopup({
                                type: POPUP_TYPES.ERROR,
                                message: 'Scraper added, but failed to reload tab content',
                            });
                        }
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error adding scraper:', error);
                    window.showPopup({
                        type: POPUP_TYPES.ERROR,
                        message: 'Error adding scraper: ' + error.message
                    });
                });
            },
            onCancel: () => {
            }
        });
    }

    function deleteScraper(scraperId) {
        window.showPopup({
            type: POPUP_TYPES.CONFIRM,
            title: 'Delete Scraper',
            message: 'Are you sure you want to delete this scraper?',
            confirmText: 'Delete',
            cancelText: 'Cancel',
            onConfirm: () => {
                fetch('/settings/scrapers/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ scraper_id: scraperId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (typeof window.reloadTabContent === 'function') {
                            window.reloadTabContent('scrapers', () => {
                                window.initializeExpandCollapse(); // Reinitialize expand/collapse
                                initializeScrapersFunctionality(); // Reinitialize scraper functionality
                                window.showPopup({
                                    type: POPUP_TYPES.SUCCESS,
                                    message: 'Scraper deleted and tab content reloaded successfully',
                                });
                            });
                        } else {
                            console.error('reloadTabContent is not a function');
                            window.showPopup({
                                type: POPUP_TYPES.ERROR,
                                message: 'Scraper deleted, but failed to reload tab content',
                            });
                        }
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting scraper:', error);
                    window.showPopup({
                        type: POPUP_TYPES.ERROR,
                        message: 'Error deleting scraper: ' + error.message
                    });
                });
            }
        });
    }

    function initializeDeleteButtons() {
        const deleteButtons = document.querySelectorAll('.delete-scraper-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const scraperId = this.getAttribute('data-scraper-id');
                deleteScraper(scraperId);
            });
        });
    }

    document.addEventListener('dashboardInitialized', function() {
        initializeScrapersFunctionality();
    });
</script>

{% for scraper_id, config in settings.Scrapers.items() %}
<div class="settings-section">
    <div class="settings-section-header{% if not config.enabled %} scraper-disabled{% endif %}">
        <span class="settings-toggle-icon">+</span>
        <h4>{{ scraper_id }}</h4>
        <button type="button" class="delete-scraper-btn" data-scraper-id="{{ scraper_id }}">Delete Scraper</button>
    </div>
    <div class="settings-section-content">
        <div class="settings-form-group">
            <label for="{{ scraper_id }}-type" class="settings-title">Type:</label>
            <input type="text" id="{{ scraper_id }}-type" name="Scrapers.{{ scraper_id }}.type" value="{{ config.type }}" class="settings-input" readonly data-section="Scrapers" data-key="{{ scraper_id }}.type">
        </div>
        <div class="settings-form-group">
            <label for="{{ scraper_id }}-enabled" class="settings-title">Enabled:</label>
            <input type="checkbox" id="{{ scraper_id }}-enabled" name="Scrapers.{{ scraper_id }}.enabled" {% if config.enabled %}checked{% endif %} data-section="Scrapers" data-key="{{ scraper_id }}.enabled">
        </div>
        {% if config.type in ['Zilean', 'MediaFusion', 'AIOStreams', 'Jackett', 'Prowlarr'] %}
        <div class="settings-form-group">
            <label for="{{ scraper_id }}-url" class="settings-title">URL:</label>
            <input type="text" id="{{ scraper_id }}-url" name="Scrapers.{{ scraper_id }}.url" value="{{ config.url | default('') }}" class="settings-input" data-section="Scrapers" data-key="{{ scraper_id }}.url">
        </div>
        {% if config.type == 'AIOStreams' %}
        <!-- AIOStreams Setup Information -->
        <div class="aiostreams-info-box">
            <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="aiostreams-info-box-content">
                <p><strong>AIOStreams Configuration Requirements:</strong></p>
                <p>AIOStreams requires specific configuration in <b>ADVANCED</b> mode to work properly with CLI-Debrid. Follow these steps in your AIOStreams settings:</p>

                <p><strong>1. Install P2P-Compatible Addons</strong></p>
                <ul>
                    <li>Add source addons that support P2P torrents (e.g., Comet, TorrentsDB, MediaFusion)</li>
                    <li>In each addon's settings, enable "Include P2P" or similar P2P option</li>
                </ul>

                <p style="margin-top: 15px; padding: 12px; background-color: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 4px; display: flex; gap: 8px; align-items: flex-start;">
                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; flex-shrink: 0; color: #fbbf24;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span><strong style="color: #3b82f6;">Important:</strong> Enabling "P2P" in AIOStreams does <strong>NOT</strong> establish actual peer-to-peer torrent connections like traditional torrent clients. It simply filters for torrent-based streams (infohashes) that CLI-Debrid can send to your debrid service just like all the other scrapers. All downloading is handled securely through your debrid provider, not through direct P2P connections.<span>
                </p>

                <p><strong>2. Configure Stream Type Filters</strong></p>
                <ul>
                    <li>Go to AIOStreams ‚Üí Filters ‚Üí Stream Type</li>
                    <li>Set <strong>P2P</strong> as the <strong>Primary Stream Type</strong></li>
                    <li>Set <strong>P2P</strong> as a <strong>Required Stream Type</strong></li>
                </ul>

                <p><strong>3. Set Custom Description Format</strong></p>
                <ul>
                    <li>Go to AIOStreams ‚Üí Formatter</li>
                    <li>Enable <strong>Custom</strong> from dropdown under <strong>Formatter Selection</strong></li>
                    <li>Paste this template into the <strong>Description Template</strong> field:</li>
                </ul>
                <pre>{stream.message::exists["‚ÑπÔ∏è {stream.message}"||""]}
{stream.title::exists["üìÅ {stream.title::title}"||""]}{stream.year::exists[" ({stream.year})"||""]}{stream.seasonEpisode::exists[" {stream.seasonEpisode::join(' ‚Ä¢ ')}"||""]}
{stream.filename::exists["‚ÑπÔ∏è {stream.filename}"||""]}
{stream.infoHash::exists["‚ÑπÔ∏è {stream.infoHash}"||""]}
{addon.name::exists["‚ÑπÔ∏è {addon.name}"||""]}
{stream.indexer::exists["‚ÑπÔ∏è {stream.indexer}"||""]}
{stream.quality::exists["üé• {stream.quality} "||""]}{stream.encode::exists["üéûÔ∏è {stream.encode} "||""]}{stream.releaseGroup::exists["üè∑Ô∏è {stream.releaseGroup}"||""]}
{stream.visualTags::exists["üì∫ {stream.visualTags::join(' ‚Ä¢ ')} "||""]}{stream.audioTags::exists["üéß {stream.audioTags::join(' ‚Ä¢ ')} "||""]}{stream.audioChannels::exists["üîä {stream.audioChannels::join(' ‚Ä¢ ')}"||""]}
{stream.size::>0["üì¶ {stream.size::bytes} "||""]}{stream.folderSize::>0["/ üì¶ {stream.folderSize::bytes}"||""]}{stream.duration::>0["‚è±Ô∏è {stream.duration::time} "||""]}{stream.age::exists["üìÖ {stream.age} "||""]}{stream.indexer::exists["üîç {stream.indexer}"||""]}
{stream.languageEmojis::exists["üåê {stream.languageEmojis::join(' / ')}"||""]}</pre>

                <p><strong>4. Optimize Your Filters</strong></p>
                <ul>
                    <li>Fine-tune your resolution, quality, and content filters to reduce scraping time</li>
                    <li>Disable addons or sources you don't need to speed up responses</li>
                    <li>If scraping remains slow after optimization, proceed to <strong>Step 5</strong> below</li>
                </ul>

                <p><strong>5. Increase Scraper Timeout (Important!)</strong></p>
                <ul>
                    <li>AIOStreams can be slow when checking multiple addons and sources</li>
                    <li>Go to <strong>cli_debrid Settings ‚Üí Version Settings ‚Üí Other Scraping Settings</strong></li>
                    <li>Find the <strong>"Scraper Timeout"</strong> setting</li>
                    <li>Set it to <strong>15 seconds minimum</strong> (20-30 seconds recommended for best results)</li>
                </ul>

                <p style="margin-top: 15px; display: flex; gap: 8px; align-items: flex-start;">
                    <svg class="info-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; flex-shrink: 0; color: #fbbf24;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <span><strong>Note:</strong> Without proper configuration, AIOStreams will not return usable results. The custom description template is required for CLI-Debrid to extract addon and indexer information.</span>
                </p>
            </div>
        </div>
        {% elif config.type == 'Jackett' %}
        <div class="settings-form-group">
            <label for="{{ scraper_id }}-api" class="settings-title">API Key:</label>
            <input type="text" id="{{ scraper_id }}-api" name="Scrapers.{{ scraper_id }}.api" value="{{ config.api }}" class="settings-input" data-section="Scrapers" data-key="{{ scraper_id }}.api">
        </div>
        <div class="settings-form-group">
            <label for="{{ scraper_id }}-enabled-indexers" class="settings-title">Enabled Indexers:</label>
            <input type="text" id="{{ scraper_id }}-enabled-indexers" name="Scrapers.{{ scraper_id }}.enabled_indexers" value="{{ config.enabled_indexers }}" class="settings-input" data-section="Scrapers" data-key="{{ scraper_id }}.enabled_indexers">
            <small class="settings-description">Leave blank to use all indexers, otherwise comma separated list of indexers to scrape.</small>
        </div>
        {% elif config.type == 'Prowlarr' %}
        <div class="settings-form-group">
            <label for="{{ scraper_id }}-api_key" class="settings-title">API Key:</label>
            <input type="text" id="{{ scraper_id }}-api_key" name="Scrapers.{{ scraper_id }}.api_key" value="{{ config.api_key }}" class="settings-input" data-section="Scrapers" data-key="{{ scraper_id }}.api_key">
        </div>
        <div class="settings-form-group">
            <label for="{{ scraper_id }}-tags" class="settings-title">Indexer IDs:</label>
            <input type="text" id="{{ scraper_id }}-tags" name="Scrapers.{{ scraper_id }}.tags" value="{{ config.tags }}" class="settings-input" data-section="Scrapers" data-key="{{ scraper_id }}.tags" placeholder="e.g., 1,5,23">
            <small class="settings-description">Comma-separated list of numeric Prowlarr Indexer IDs. If provided, searches will only use these indexers, otherwise all indexers will be used.</small>
        </div>
        {% endif %}
        {% elif config.type == 'Torrentio' %}
        <div class="settings-form-group">
            <label for="{{ scraper_id }}-opts" class="settings-title">Options:</label>
            <input type="text" id="{{ scraper_id }}-opts" name="Scrapers.{{ scraper_id }}.opts" value="{{ config.opts }}" class="settings-input" data-section="Scrapers" data-key="{{ scraper_id }}.opts">
            <small class="settings-description">Leave blank to use default options, otherwise copy from Torrentio URL. Recommend leaving blank.</small>
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}
