<h3>Notification Settings</h3>
<div class="settings-expand-collapse-buttons">
    <button type="button" class="settings-expand-all">Expand All</button>
    <button type="button" class="settings-collapse-all">Collapse All</button>
</div>
<button id="add-notification-btn" class="add-source-link">Add New Notification</button>

{% if notification_settings %}
    {% for notification_id, config in notification_settings.items() %}
        {% if config is not none %}
        <div class="settings-section" data-notification-id="{{ notification_id }}">
            <div class="settings-section-header">
                <span class="settings-toggle-icon">+</span>
                <h4>{{ config.title }}_{{ notification_id.split('_')[-1] }}</h4>
                <button type="button" class="delete-notification-btn" data-notification-id="{{ notification_id }}">Delete Notification</button>
            </div>
            <div class="settings-section-content" style="display: none;">
                {% for key, value in config.items() %}
                    {% if key not in ['type', 'title'] %}
                    <div class="settings-form-group">
                        {% if key == 'enabled' %}
                            <label class="settings-title">
                                <input type="checkbox" id="notifications-{{ notification_id }}-{{ key }}" name="Notifications.{{ notification_id }}.{{ key }}" {% if value %}checked{% endif %}>
                                {{ key|replace('_', ' ')|title }}
                            </label>
                        {% else %}
                            <label for="notifications-{{ notification_id }}-{{ key }}" class="settings-title">{{ key|replace('_', ' ')|title }}:</label>
                            <input type="{% if 'password' in key %}password{% else %}text{% endif %}" id="notifications-{{ notification_id }}-{{ key }}" name="Notifications.{{ notification_id }}.{{ key }}" value="{{ value }}" class="settings-input">
                        {% endif %}
                        {% if settings_schema['Notifications'] is defined and settings_schema['Notifications'].schema is defined and settings_schema['Notifications'].schema[config.type] is defined and settings_schema['Notifications'].schema[config.type][key] is defined and settings_schema['Notifications'].schema[config.type][key].description is defined %}
                        <p class="settings-description">{{ settings_schema['Notifications'].schema[config.type][key].description }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    {% endfor %}
{% else %}
    <p>No Notifications configured.</p>
{% endif %}

<script>
function initializeNotificationsFunctionality() {
    console.log('Initializing Notifications Functionality');

    const addNotificationBtn = document.getElementById('add-notification-btn');

    if (addNotificationBtn) {
        // Remove existing listener before adding a new one
        addNotificationBtn.removeEventListener('click', addNotificationHandler);
        addNotificationBtn.addEventListener('click', addNotificationHandler);
    }

    document.querySelectorAll('.delete-notification-btn').forEach(button => {
        // Remove existing listeners before adding new ones
        button.removeEventListener('click', deleteNotificationHandler);
        button.addEventListener('click', deleteNotificationHandler);
    });
}

// Separate handler function for add button
function addNotificationHandler(e) {
    e.preventDefault();
    showAddNotificationPopup();
}

// Separate handler function for delete button
function deleteNotificationHandler(e) {
    e.stopPropagation();
    const notificationId = this.getAttribute('data-notification-id');
    deleteNotification(notificationId);
}

function showAddNotificationPopup() {
    import('/static/js/notifications.js').then(module => {
        const { showPopup, POPUP_TYPES } = module;
        showPopup({
            type: POPUP_TYPES.PROMPT,
            title: 'Add New Notification',
            message: 'Select the notification type:',
            dropdownOptions: [
                { value: 'Telegram', text: 'Telegram' },
                { value: 'Discord', text: 'Discord' },
                { value: 'Email', text: 'Email' }
            ],
            confirmText: 'Add',
            cancelText: 'Cancel',
            onConfirm: (selectedType) => {
                if (selectedType) {
                    addNotification(selectedType);
                }
            }
        });
    });
}

function addNotification(notificationType) {
    fetch('/settings/notifications/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: notificationType })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            return updateNotificationsTab();
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .then(() => {
        showPopup({
            type: POPUP_TYPES.SUCCESS,
            title: 'Success',
            message: 'Notification added successfully',
            confirmText: 'OK'
        });
        initializeNotificationsFunctionality();
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error adding notification: ' + error.message, 'error');
    });
}

function deleteNotification(notificationId) {
    import('/static/js/notifications.js').then(module => {
        const { showPopup, POPUP_TYPES } = module;
        showPopup({
            type: POPUP_TYPES.CONFIRM,
            title: 'Delete Notification',
            message: 'Are you sure you want to delete this notification?',
            confirmText: 'Delete',
            cancelText: 'Cancel',
            onConfirm: () => {
                performDeleteNotification(notificationId);
            }
        });
    });
}

function performDeleteNotification(notificationId) {
    fetch('/settings/notifications/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ notification_id: notificationId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            return updateNotificationsTab();
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    })
    .then(() => {
        showPopup({
            type: POPUP_TYPES.SUCCESS,
            title: 'Success',
            message: 'Notification deleted successfully',
            confirmText: 'OK'
        });
        initializeNotificationsFunctionality();    })
    .catch(error => {
        console.error('Error:', error);
        showPopup({
            type: POPUP_TYPES.ERROR,
            title: 'Error',
            message: 'Error deleting notification: ' + error.message,
            confirmText: 'OK'
        });
    });
}

function updateNotificationsTab() {
    return fetch('/settings')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newNotificationsTab = doc.getElementById('notifications');
            
            if (newNotificationsTab) {
                const currentNotificationsTab = document.getElementById('notifications');
                if (currentNotificationsTab) {
                    currentNotificationsTab.innerHTML = newNotificationsTab.innerHTML;
                    initializeNotificationsFunctionality();
                    initializeExpandCollapse();
                }
            } else {
                throw new Error('Notifications tab not found in the response');
            }
        })
        .catch(error => {
            console.error('Error updating Notifications tab:', error);
            showPopup({
                type: POPUP_TYPES.ERROR,
                title: 'Error',
                message: 'Error updating Notifications tab: ' + error.message,
                confirmText: 'OK'
            });
            initializeNotificationsFunctionality();
        });
}

document.addEventListener('DOMContentLoaded', function() {
    initializeNotificationsFunctionality();
});
</script>