<h3>{{ tab_title }} Settings</h3>
<div class="settings-expand-collapse-buttons">
    <button type="button" class="settings-expand-all">Expand All</button>
    <button type="button" class="settings-collapse-all">Collapse All</button>
</div>

{% for section, section_data in settings_schema.items() %}
    {% if section_data.tab == tab_title %}
    <div class="settings-section">
        <div class="settings-section-header">
            <h4>{{ section }}</h4>
            <span class="settings-toggle-icon">+</span>
        </div>
        <div class="settings-section-content">
            {% for key, value in section_data.items() %}
                {% if key != 'tab' %}
                <div class="settings-form-group">
                    <label for="{{ section|lower }}-{{ key }}" class="settings-title">{{ key|replace('_', ' ')|title }}:</label>
                    {% if value.type == 'boolean' %}
                        <input type="checkbox" id="{{ section|lower }}-{{ key }}" name="{{ section }}.{{ key }}" {% if settings[section][key] %}checked{% endif %}>
                    {% elif value.type == 'string' and value.get('choices') %}
                        <select id="{{ section|lower }}-{{ key }}" name="{{ section }}.{{ key }}" class="settings-input">
                            {% for option in value.choices %}
                                <option value="{{ option }}" {% if settings[section][key] == option %}selected{% endif %}>{{ option }}</option>
                            {% endfor %}
                        </select>
                    {% elif value.type == 'dict' %}
                        <!-- Handle nested structures here -->
                        <div class="nested-settings">
                            {% for nested_key, nested_value in value.get('schema', {}).items() %}
                                <div class="settings-form-group">
                                    <label for="{{ section|lower }}-{{ key }}-{{ nested_key }}" class="settings-title">{{ nested_key|replace('_', ' ')|title }}:</label>
                                    {% if nested_value.type == 'boolean' %}
                                        <input type="checkbox" id="{{ section|lower }}-{{ key }}-{{ nested_key }}" name="{{ section }}.{{ key }}.{{ nested_key }}" {% if settings[section][key][nested_key] %}checked{% endif %}>
                                    {% else %}
                                        <input type="{{ nested_value.type }}" id="{{ section|lower }}-{{ key }}-{{ nested_key }}" name="{{ section }}.{{ key }}.{{ nested_key }}" value="{{ settings[section][key][nested_key] }}" class="settings-input">
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <input type="{{ value.type }}" id="{{ section|lower }}-{{ key }}" name="{{ section }}.{{ key }}" value="{{ settings[section][key] }}" class="settings-input">
                    {% endif %}
                    {% if value.description %}
                        <p class="settings-description">{{ value.description }}</p>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endfor %}